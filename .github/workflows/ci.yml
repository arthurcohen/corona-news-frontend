name: CI

on:
  push:
    branches: 
        - master
        - dev

jobs:
  build:
    name: Build

    runs-on: ubuntu-latest

    strategy:
      matrix:
        node-version: [10.x]

    steps:
    - uses: actions/checkout@v2
    - name: Use Node.js ${{ matrix.node-version }}
      uses: actions/setup-node@v1
      with:
        node-version: ${{ matrix.node-version }}

    - name: Install Dependencies
      run: npm ci

    - name: Build
      run: npm run build
        
    - name: Deploy Staging
      if: github.ref == 'refs/heads/dev'
      uses: actions-hub/gcloud@master
      env:
        PROJECT_ID: thegoodnewscoronavirus
        APPLICATION_CREDENTIALS: ewogICJ0eXBlIjogInNlcnZpY2VfYWNjb3VudCIsCiAgInByb2plY3RfaWQiOiAidGhlZ29vZG5ld3Njb3JvbmF2aXJ1cyIsCiAgInByaXZhdGVfa2V5X2lkIjogIjY1YWIyYjA0OWViMTU4YWVmYzdiNzBiNzZlY2E4ZWIzYjllMzk2YTIiLAogICJwcml2YXRlX2tleSI6ICItLS0tLUJFR0lOIFBSSVZBVEUgS0VZLS0tLS1cbk1JSUV2Z0lCQURBTkJna3Foa2lHOXcwQkFRRUZBQVNDQktnd2dnU2tBZ0VBQW9JQkFRREVTM1ZGcXRYQ3NqSUVcbnVDMDlLemR5Q1NVeW9nREZoTHJoYnhiVXNpV0g5SlVOaWNZRFhsb2dXYmY0MElaWnV2UThQR2JGRDhMZFo4SW5cbndPanZFZVRCUm1LWlIweVViMlpHWDRjKzluQWZqVEgzNnJNR0lYYUNETXBEc2ZHWUZkb09zUHk0STNKZTYrT0tcbmxFby8ydDI3QzJML0dmaldWZ3RydmkvdG9QQkpwK3didVluS1dOeWp6OTVUR3BnejVSZThTVlNjQVl4TjNaN3JcbnJUa0gvdHlFZENDMDJqRGtYczYyQWcrUkV3cXNMdFAvbjZjNmRrb0ZFS01YdTZZQ1lsZnNKRXoySEIzeWNENWlcbmxXVnhPSGRBdmlaK25Zc0J2Y3pDMnBrQWlUNFBrem82YnNONEEvOVNTREtBYWI0cjc5NzNsQ09oWTJVeERNT2tcbmRJREV3V1dOQWdNQkFBRUNnZ0VBUGFSbW9PaWJkU2NwYnZMNWZlYUc1R0E3MXJFcUpkemZKUEVTVGR2ZHpscC9cbnZqOGdPQ21XaXVjeHowaUlrRUFWOTU2T05WOFVOaHdoekFNWUF3OXU4MFRycksvSHZDdFpoa3IwZVZEQmVCOEtcbmJJeS9DSE5VdUZWVTVUcEpvSlZvSTBud0t0RXkxdDBqMlA1bGJMVUtBWFY3Y3BuUTIxb3Mvdm84S2RicTdtM25cbjNJbG54TUo4emYyeHZNZU9IZkFJUS9yZU43RXM5cEdqd2NCK1JacGpsR0VuVzlQMERQNDZHb2hZV29OTDg5Mi9cbjd5U1FrejJtcWJqYjBCZnhaMlYyQmdvMEZmM1dBYmowMEdvN01kVmxLZDh1S2hrRWUzOCtuZWgyTko1WkROa3pcbktiTWhodzZwbDNyQkVmUklaQURGYlFuZm1aOThpTllIdXg0eE5tWGI3d0tCZ1FEK1V5VDVnWkh6L2JOMWt5WXZcbk5HeVNhYnRQWENzdytkQzBCcWhRbFVNYURzVzI1WVFCQlI3MzR5YmI4RFUva2dXZzNmRFo4c0dMU20zNWZ3dllcbktBdWNsRWgxc3dJNU1UY0VvdEdPL3poMm1sSkVKOGNpTk1XWEg5NHFkMzJPTjF5UUtqd3lkcWN4VUFWQzdVRzRcbjcwMXVFbWJPUHpGclk5a3daZE4zNWhSeFd3S0JnUURGbG5YZmRtR1pVRDZ1a0ZXeVVERUpyRUFjNDR3OHZuMUdcblRidkNxZVJhRkw5d2RYRlJZSWU5eVhwWTNiMmptMEdUakJxMm5tV0VLd0k1YjFlNVQ5dUgrR1NrbWg1dGR1VWVcbmZaN0pjSWYxM0xnci9LREF3QWxVa0hIZmI4R3ZlQTZwRlBPblQrL2pLTllyUVIzeit2K1VIbFlyUFl5SkliWUFcbng4QTRvbUlSTndLQmdRRGtkOWpOYzhLa0I1TkIyakVCVXZ6K0FwSE1WeVpOMXYzUDIvTTBnUUpJMUdCMVQzWG9cblhLdFhVTzVGd21KemUwQW5KWG9Lc1BPQnFCbG5ldVF2Q0xwMXJSZnk5QjdaTmdjUTJSdWNkRlpLNVpObHVyNC9cblVsejJ5Q0FTMGtrdWl6bFNJVDcycm5TLzdmenNCS3QzOFRJRDRmQU04K1AzYnpsYkt2NXZ4WGN6NVFLQmdGU2dcbjJ4KzVMcGhoL0ZiOFR4Z3VyTEk5NnIvMDNrM3VNTzM1d1YvaE1JTTh1N3BKTXgzdHdIWVRZNm5JWDc5QmNsYmxcbi9WTVdpTmlSSzBTNllkSm5WOW5uRkFSRVZwLy8rcWFTbTM0Z0Nydk5xN3g3V2NiMCtZb1V6QkV0WnNIbkpEQmJcblh2amNqaHkza3ZPMzBrSjcwUmY1M21KcTNGU244YkpuMi9ibDVpY0ZBb0dCQUkzYTl0ODJiWlB5ZjFqRzk5N01cbm1ZekM4ZWczRnhTcWVGMFdhOElHTjNtWnZuL2RxbDk2OUZQNFE3RU1yUGhzNDYraFBPeTV1UHhNZjM0MmVSNnBcbmplTFl5VWRFUE9qTm1VZGo3ajh6QS94bXFCditaMjIwbEJKZnRsRXAwOTZQM2tmUTUzMzNoM1VSZFJpb2x4M01cbllBTkN6Z3pvdysyS08zd0VRZDhyeEptaVxuLS0tLS1FTkQgUFJJVkFURSBLRVktLS0tLVxuIiwKICAiY2xpZW50X2VtYWlsIjogInRoZWdvb2RuZXdzY29yb25hdmlydXNAYXBwc3BvdC5nc2VydmljZWFjY291bnQuY29tIiwKICAiY2xpZW50X2lkIjogIjExMDkwODQyNzA3MDU4MTkxODkyMyIsCiAgImF1dGhfdXJpIjogImh0dHBzOi8vYWNjb3VudHMuZ29vZ2xlLmNvbS9vL29hdXRoMi9hdXRoIiwKICAidG9rZW5fdXJpIjogImh0dHBzOi8vb2F1dGgyLmdvb2dsZWFwaXMuY29tL3Rva2VuIiwKICAiYXV0aF9wcm92aWRlcl94NTA5X2NlcnRfdXJsIjogImh0dHBzOi8vd3d3Lmdvb2dsZWFwaXMuY29tL29hdXRoMi92MS9jZXJ0cyIsCiAgImNsaWVudF94NTA5X2NlcnRfdXJsIjogImh0dHBzOi8vd3d3Lmdvb2dsZWFwaXMuY29tL3JvYm90L3YxL21ldGFkYXRhL3g1MDkvdGhlZ29vZG5ld3Njb3JvbmF2aXJ1cyU0MGFwcHNwb3QuZ3NlcnZpY2VhY2NvdW50LmNvbSIKfQo=
      with:
        args: app deploy app.staging.yaml
        
    - name: Deploy Production
      if: github.ref == 'refs/heads/master'
      uses: actions-hub/gcloud@master
      env:
        PROJECT_ID: ${{ secrets.GCLOUD_PROJECT_ID }}
        APPLICATION_CREDENTIALS: ${{ secrets.GOOGLE_APPLICATION_CREDENTIALS }}
      with:
        args: app deploy
    
          
    # - name: Deploy to Firebase Staging
    #   if: github.ref == 'refs/heads/dev'
    #   uses: w9jds/firebase-action@master
    #   with:
    #     args: "deploy --only hosting:staging"
    #   env:
    #     FIREBASE_TOKEN: ${{ secrets.FIREBASE_TOKEN }}
    #     PROJECT_ID: 'goodnews-2c75a'

    # - name: Deploy to Firebase Prod
    #   if: github.ref == 'refs/heads/master'
    #   uses: w9jds/firebase-action@master
    #   with:
    #     args: "deploy --only hosting:prod"
    #   env:
    #     FIREBASE_TOKEN: ${{ secrets.FIREBASE_TOKEN }}
    #     PROJECT_ID: 'goodnews-2c75a'