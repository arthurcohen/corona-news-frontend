name: CI

on:
  push:
    branches: 
        - master
        - dev

jobs:
  build:
    name: Build

    runs-on: ubuntu-latest

    strategy:
      matrix:
        node-version: [10.x]

    steps:
    - uses: actions/checkout@v2
    - name: Use Node.js ${{ matrix.node-version }}
      uses: actions/setup-node@v1
      with:
        node-version: ${{ matrix.node-version }}

    - name: Install Dependencies
      run: npm ci

    - name: Build
      run: npm run build
        
    - name: Deploy Staging
      if: github.ref == 'refs/heads/dev'
      uses: actions-hub/gcloud@master
      env:
        PROJECT_ID: thegoodnewscoronavirus
        APPLICATION_CREDENTIALS: ewogICJ0eXBlIjogInNlcnZpY2VfYWNjb3VudCIsCiAgInByb2plY3RfaWQiOiAidGhlZ29vZG5ld3Njb3JvbmF2aXJ1cyIsCiAgInByaXZhdGVfa2V5X2lkIjogImNlMzc1MmQ3NjRiZDAzYzUzZmRhM2E1NTQxNDUzYWUwMmVjNjNlODEiLAogICJwcml2YXRlX2tleSI6ICItLS0tLUJFR0lOIFBSSVZBVEUgS0VZLS0tLS1cbk1JSUV2UUlCQURBTkJna3Foa2lHOXcwQkFRRUZBQVNDQktjd2dnU2pBZ0VBQW9JQkFRREl6VjcrQ2YzSUE2elpcbnhUaFhIeE1Jc3JRQWM2K1UwdEtHU05JQTFudmxpL0lEdkFPaUxydlpOK1hHK0ZrQ21nSm5EZC9rTklUcFBaWmpcblMvM3J0eEV0MW5sc3VxZDlQc1VwNWtiVmhTa25IWldhSVh4d0k4MGh2M1RtRytvTkI0V0tLZ0Y5Vm1Hd0dPNHlcbklWQXdhai9FRmJNODY4N1pwRFVpRG4zdlJhbmRxZ2V5aVBCOWduZUV3MkZXTFhnMHduZDF6N0NSRXJNam5DS3BcblF6SHJucDFPY0tKSVJHRGFQai8xa2F0VTMrVHg1N2RYMU8xR3h6cm8yWEF6aDBWdnJmZTlmMFpLSkdZempCWHdcblVFVTU0VGo1UXhxcHl1WnZOcEs4Sm1FZHlZWHFpdG4yYUVNNmlON1lVRTNqaTRWTGhadEhUcFF5dTJydmFaWG1cbkl4OUp5VS9CQWdNQkFBRUNnZ0VBVzBUZGxHSStNNWRZRFhPUzlDWnZwRmgxY0c4a3MyUlB4REY5SWx4YTNDOExcbnhaN0RtQWZkNGhHQ0l6bm1XMFJkS3pJblBiYVJZdUpYWkxLNXExWCtQUE5ySlh5QmZHLzNkZC93K2tRWVBHczZcbkFHQ1FDdmg2MklnSlBqNFoxK28vVEZsamEvRERYaU0yd1JwYk5HWldyVzJmbG1Vb0U4eUxTZnVFU2lsRDJEZ09cblE4bmlqbFgzR0Ricnh4M2FWYk95MXpoWExOdmZndTFRUzA0MVVVd3NreHNKWTRzVVdzWGtkYURQL1hwY0l0RUVcbmk3T1lodzhYYTNmNkMrWGUxb3hvM2M0a3BjcE5jZjhLckowTFVtMHlBeGl2MEIrdmdlM0Z0ZHloYmU4T2wvOVhcbm5LWjdJTHR0WmVVWngvZURRajd5TEF5bzJra09FRWFncnQzcEZwY2dNUUtCZ1FEakc1c0VTWkdSbFVLQXZNNUNcbmcyS1BGZm9CNGJDOGFiK3hoMHAyemMybnpYUjAxdk9CcVgwcUxRUWl2aUdRbVduZ04rSEN3UzIxMW5haE5OQ0tcbmVTWkRHQzFJTm4wakdidXhyNHBOTXBnSDg1aWRSOUM0R2JnMWpsWVJMcDExV3N1ajlqSFJ5T2Q2N1JYQ2k0Y3lcbi9MZlFETXJiUlBkczVISkluUStWRytuMUF3S0JnUURpV1EwRFZoSjR0QlY4YUwvM2FDdU1TaVo2K1E4bDcxZnRcbm1wT09aYThtcXdmVHFmK1NweWxBY3M2N1BXRWZId0Vwd2xlVHdsaUhBbDh2b0xJSUdZZ1d2SkV3ZVJLRnljZ3JcbmdETXV5MTBYY1pXUVlzV3hEWkZHSm1jWHRRRFpaVTlhbkpLQk1lakZnRzgrODFvaG5hMnV6dHV1OS81S255ZjRcbmJwZkpIaWtpNndLQmdBR2RacUxIS3lQUDNlTXdkSDhBbENqVVRTektRQWwyN3dnQ0lFTnIvelJjUDZHOURZbzBcbmZGRmFkSmNTcHdaeU1OQ0pWUytmVkFYZytvTDI3eXlzNDlyQ1IwQW1Nd21XMjBET01MdVB5b2p6OEhmZDFOd2FcblFyY094Z25sUFBWaXFlUUdraUFkdjVlZUsvTndMb3ZzUkJwVW5QU21MdVExVTZLMGl6SFNPdjJsQW9HQUJwUlNcbkZZTzkrN1k0WGFwcDBoWThGZExkOVhzaDNwZHJkZU9sWUdGQ1N4eHptTXA3UEZjUmt1Y0RiVnZtWTlJeDVYWFpcbnQ5alJXL05Nc3dTM3lCWjk1ek5LQVIrejB5Ry9hTXhNTUpNR3ZMUzNoVC9wd1RERXhVWStmdWpyQW1hNGZNaktcblZXa08vQmEwcFI3THd1aGpjUTVnUW1EQkNvZy8wQy9leDZEUnowc0NnWUVBcmNtUlBYTUR1Zklyc1JTSE1oYWNcbk5vSis4NlZhSytnVTZWSzhtL080QTBHVmtSdzJpRzFTbFZ5dHhxWHpGVTVmWGJzUmltbHlyWjVsN0E4cm9pRTBcbnNUZmFxU2FSeHNvSkppZDY5dVFrYVN3b1U2SVBkOFNQZnBJSi9UTWYwUGZERE8xdUlLVWp5ckF2bmRPTEVqV1hcbll0OEl5NW1WNEdUa01QNzl4bzhpeGt3PVxuLS0tLS1FTkQgUFJJVkFURSBLRVktLS0tLVxuIiwKICAiY2xpZW50X2VtYWlsIjogImRlcGxveUB0aGVnb29kbmV3c2Nvcm9uYXZpcnVzLmlhbS5nc2VydmljZWFjY291bnQuY29tIiwKICAiY2xpZW50X2lkIjogIjEwNzcyMzg2NjY2MDk5MTU4NTY3NyIsCiAgImF1dGhfdXJpIjogImh0dHBzOi8vYWNjb3VudHMuZ29vZ2xlLmNvbS9vL29hdXRoMi9hdXRoIiwKICAidG9rZW5fdXJpIjogImh0dHBzOi8vb2F1dGgyLmdvb2dsZWFwaXMuY29tL3Rva2VuIiwKICAiYXV0aF9wcm92aWRlcl94NTA5X2NlcnRfdXJsIjogImh0dHBzOi8vd3d3Lmdvb2dsZWFwaXMuY29tL29hdXRoMi92MS9jZXJ0cyIsCiAgImNsaWVudF94NTA5X2NlcnRfdXJsIjogImh0dHBzOi8vd3d3Lmdvb2dsZWFwaXMuY29tL3JvYm90L3YxL21ldGFkYXRhL3g1MDkvZGVwbG95JTQwdGhlZ29vZG5ld3Njb3JvbmF2aXJ1cy5pYW0uZ3NlcnZpY2VhY2NvdW50LmNvbSIKfQo=
      with:
        args: app deploy app.staging.yaml
        
    - name: Deploy Production
      if: github.ref == 'refs/heads/master'
      uses: actions-hub/gcloud@master
      env:
        PROJECT_ID: ${{ secrets.GCLOUD_PROJECT_ID }}
        APPLICATION_CREDENTIALS: ${{ secrets.GOOGLE_APPLICATION_CREDENTIALS }}
      with:
        args: app deploy
    
          
    # - name: Deploy to Firebase Staging
    #   if: github.ref == 'refs/heads/dev'
    #   uses: w9jds/firebase-action@master
    #   with:
    #     args: "deploy --only hosting:staging"
    #   env:
    #     FIREBASE_TOKEN: ${{ secrets.FIREBASE_TOKEN }}
    #     PROJECT_ID: 'goodnews-2c75a'

    # - name: Deploy to Firebase Prod
    #   if: github.ref == 'refs/heads/master'
    #   uses: w9jds/firebase-action@master
    #   with:
    #     args: "deploy --only hosting:prod"
    #   env:
    #     FIREBASE_TOKEN: ${{ secrets.FIREBASE_TOKEN }}
    #     PROJECT_ID: 'goodnews-2c75a'