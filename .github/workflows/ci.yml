name: CI

on:
  push:
    branches: 
        - master
        - dev

jobs:
  build:
    name: Build

    runs-on: ubuntu-latest

    strategy:
      matrix:
        node-version: [10.x]

    steps:
    - uses: actions/checkout@v2
    - name: Use Node.js ${{ matrix.node-version }}
      uses: actions/setup-node@v1
      with:
        node-version: ${{ matrix.node-version }}

    - name: Install Dependencies
      run: npm ci

    - name: Build
      run: npm run build
        
    - name: Deploy Staging
      if: github.ref == 'refs/heads/dev'
      uses: actions-hub/gcloud@master
      env:
        PROJECT_ID: ${{ secrets.GCLOUD_PROJECT_ID }}
        APPLICATION_CREDENTIALS: ewogICJ0eXBlIjogInNlcnZpY2VfYWNjb3VudCIsCiAgInByb2plY3RfaWQiOiAidGhlZ29vZG5ld3Njb3JvbmF2aXJ1cyIsCiAgInByaXZhdGVfa2V5X2lkIjogIjE5YWI3ZTc2OTM5YTkyZDQ1NzRlMWEzMjhlOGMzNGM0MDJhMGRiODciLAogICJwcml2YXRlX2tleSI6ICItLS0tLUJFR0lOIFBSSVZBVEUgS0VZLS0tLS1cbk1JSUV2Z0lCQURBTkJna3Foa2lHOXcwQkFRRUZBQVNDQktnd2dnU2tBZ0VBQW9JQkFRRFc1MThFZU85WEs0dlhcbnZBck1hZ0lCTXVJdGpsZWQweHV4WDU3S3N1bkZRSmN2UmU5TzFTRkVxWVpIRkpmTzEvQ0daT1FVbGF2bFBzd0xcbmVLdm5SdWlyb0FyRnlEUVZ6Y0RWRjdjWVJ3THBBOWkvTUk4ejVXdDdDK1lIdi9JTFhQVmpDVXpZcFNzMTVodFNcbkw2UHlkbEplSkdXTEt1OWUvdW5VZlpYSDRxMnY2K3BSbjQ2b2szVXVpYldKTSswN3JmRkxIMHh0eW9LRWtmb1lcbjQxSDRnN0ZEYnhiaGpFeWpmZUk5Z2UxUzZvSWhLZVdBR1VJK043K1hsRHhQMDlPYzltQUpyM1h5TGQ4VC9uMWxcbllTUDAwSlRITTV1TCtBZVJGOThZZitVRWtlbFhwQllub3FlRkptS1YrVEFHRmxrNHlydGhaUXRleXVoWEk1eHpcbnBzVFYvMjdiQWdNQkFBRUNnZ0VBV0plUE14L0x3d3EvbnBMMWZLbGk1QzJlMGhyeEFhNEtwNGQ4eGFFVi8rd05cbnB6NVVWaEpFb2JLbEdWNWk2ckZZaFg3SUM3aGI0YWlPbzFmK3Zkd2NoTXY0Uk9xd2xpQjVFeCt3cWtCejhhMVZcblNCUHpwUGc1NDhMVzlIRHJqa1duSDBteE5VcDUwc0ZtbCszdHowRjUyVGQxNlBZdE1lTXljQmZKakZwbE1iVDFcbkNhd1dWbmZJNlpER3RtYjhhZkVIUUNRZ25iQVBoSjdzQnpYNDM1WGdNM3dTcHVSOGZCelVQUWVlOWJIZ2ZVL3JcbkYrdjM3OUg3Q2RocEpWZVlQMnZyWGY0ZHlySDVBWUpDKzhPTUYxRG93by93ZVR1UnZVbFhmNXBmR2N4U1FReDZcbnZJRzU0LzhOeVBuR25KMXJ5bU5MQ0pwRkRmZlJRTmlSTnBCdWdzd0QwUUtCZ1FEMkxqbkJJSncyTUV2VVREU2pcbmhRM3ZCTnAxRFFSVHgxZ1V5eUEvMjZYVEhXQXNPWHZmRU9jSk10TjQ3QXVNRVlQbGlSdnQvWWtzb05nbHdvWnVcbkx1SVMyNlBRWmNFZ2s3V252cFJkS1Q5dTU3cW5UQmtwRTVZQnE1emZjcEhCbFp4N0lXSytnNFVLdTJTSFJJT3NcbnJNSFlWNGYwdWhjL3BzSWxmaXNZVUtsNUtRS0JnUURmZWNaNDB3QlI3QUVaNjBydXh3MG4wSnVjWlFxTDVWNm5cbmtjdlRTT2xIUDJjVndzMkNJMmFNUEFwdkFkME9DcmVoUkp6R1l5SzhXc0VHWVMxa1RXQ3g4WDRMN3VwZmxJOUFcbmYwcWMzZ2ptRnJvZ1dNOUtwNVpYOUNrV0pwNjhybHh1c3JXSkZERjhubGxZck1PdjMrNGRVc3MySG1nU0ZwMGZcbk9VL3N1L2QwWXdLQmdFeUFoUFlkT2k0a3lBdkxPcmh1Q3F4eVo2amtTS240VXNqemJxd3BoOWlaVWwrcjVYQ21cbmdnVjd3L2ZaOHFTdWRMeUo1U0lLSGV5K2R5MFV6RTNGUi8vd1BYSHZqUnFnakZ6NmZvU000dWVHSDUwSnF1LzJcbjVERFVzY1ZHaDBFUFN6ZUFZbjB0eGRSVjg2R05peFhJQWQxSEpqckk4WnlZSjlFYTZpMStNNHd4QW9HQkFJdGNcbi85NjloMGVQYkNoanlia2F2U09GUG1YTHhVWDA1cENOcFpTL3RXclBLVlF5eGNKUW5WVDY1RzdSdEs5YkU2VW9cbmlyUlZnb1gvK3J3bHdnNzVDa0l1SGJNSGJYWHB5V1FwZmJoUjV5N0dJWkNta2E4Mno5Vk4ySW1OMEJST2tDb2dcbm5JRTk3SmFRa1p0eE1oL3VBQ3FkUlVrY3NUNEdpRG0rbmc4K01WV05Bb0dCQU5uSzhyZnVyK2hWcWZac2dJbndcbktHOVRwNUhtMVFaWnIzQWJkT29leDJwNW11T1NCTUdBSmU1Tm16ekx5TkZ4YWl0VjBjNkp0SGk5MldCMTY3U1FcbjZBRVFERW53Y0ZqajFnY0UwQ1p6TFBQeldnSU5CNEVuOXc0S09EV0MwbG1qZUFYSWxDNUxyZW1nM2V5U2o5OS9cbmNxSFQ3aitaKzZhUHBSTmd1YW1YMW5WNFxuLS0tLS1FTkQgUFJJVkFURSBLRVktLS0tLVxuIiwKICAiY2xpZW50X2VtYWlsIjogImhvc3RpbmdAdGhlZ29vZG5ld3Njb3JvbmF2aXJ1cy5pYW0uZ3NlcnZpY2VhY2NvdW50LmNvbSIsCiAgImNsaWVudF9pZCI6ICIxMTc0MDExMjI1Mzk4OTE0NTExODQiLAogICJhdXRoX3VyaSI6ICJodHRwczovL2FjY291bnRzLmdvb2dsZS5jb20vby9vYXV0aDIvYXV0aCIsCiAgInRva2VuX3VyaSI6ICJodHRwczovL29hdXRoMi5nb29nbGVhcGlzLmNvbS90b2tlbiIsCiAgImF1dGhfcHJvdmlkZXJfeDUwOV9jZXJ0X3VybCI6ICJodHRwczovL3d3dy5nb29nbGVhcGlzLmNvbS9vYXV0aDIvdjEvY2VydHMiLAogICJjbGllbnRfeDUwOV9jZXJ0X3VybCI6ICJodHRwczovL3d3dy5nb29nbGVhcGlzLmNvbS9yb2JvdC92MS9tZXRhZGF0YS94NTA5L2hvc3RpbmclNDB0aGVnb29kbmV3c2Nvcm9uYXZpcnVzLmlhbS5nc2VydmljZWFjY291bnQuY29tIgp9Cg==
      with:
        args: app deploy app.staging.yaml
        
    - name: Deploy Production
      if: github.ref == 'refs/heads/master'
      uses: actions-hub/gcloud@master
      env:
        PROJECT_ID: ${{ secrets.GCLOUD_PROJECT_ID }}
        APPLICATION_CREDENTIALS: ${{ secrets.GOOGLE_APPLICATION_CREDENTIALS }}
      with:
        args: app deploy
    
          
    - name: Deploy to Firebase Staging
      if: github.ref == 'refs/heads/dev'
      uses: w9jds/firebase-action@master
      with:
        args: "deploy --only hosting:staging"
      env:
        FIREBASE_TOKEN: ${{ secrets.FIREBASE_TOKEN }}
        PROJECT_ID: 'goodnews-2c75a'

    - name: Deploy to Firebase Prod
      if: github.ref == 'refs/heads/master'
      uses: w9jds/firebase-action@master
      with:
        args: "deploy --only hosting:prod"
      env:
        FIREBASE_TOKEN: ${{ secrets.FIREBASE_TOKEN }}
        PROJECT_ID: 'goodnews-2c75a'